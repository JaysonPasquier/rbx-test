-- Rift Scanner & Teleporter - TAB MENU Version (FIXED)
-- Fixed ScrollFrame error + emoji-only mini button

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Script start time
local SCRIPT_START = tick()

-- Wait for modules
local success, Rifts = pcall(function() return require(ReplicatedStorage.Shared.Data.Rifts) end)
local success2, WorldUtil = pcall(function() return require(ReplicatedStorage.Shared.Utils.WorldUtil) end)

local RIFT_DATA = success and Rifts or {}

-- Main ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "RiftMenu"
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false

-- Mini button (emoji only)
local MiniBtn = Instance.new("TextButton")
MiniBtn.Size = UDim2.new(0, 50, 0, 50)
MiniBtn.Position = UDim2.new(1, -60, 0, 20)
MiniBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 255)
MiniBtn.Text = "ðŸŒ€"
MiniBtn.TextColor3 = Color3.new(1,1,1)
MiniBtn.TextScaled = true
MiniBtn.Font = Enum.Font.GothamBold
MiniBtn.Parent = ScreenGui

local MiniCorner = Instance.new("UICorner")
MiniCorner.CornerRadius = UDim.new(0, 12)
MiniCorner.Parent = MiniBtn

-- Main menu frame (hidden initially)
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 650, 0, 550)
MainFrame.Position = UDim2.new(1, -670, 0, 80)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Visible = false
MainFrame.Parent = ScreenGui

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 12)
MainCorner.Parent = MainFrame

-- Header with tabs & controls
local Header = Instance.new("Frame")
Header.Size = UDim2.new(1, 0, 0, 55)
Header.BackgroundColor3 = Color3.fromRGB(35, 35, 55)
Header.Parent = MainFrame

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 12)
HeaderCorner.Parent = Header

-- Tab buttons
local Tabs = {"INFO", "EGGS", "QUESTS", "RIFTS"}
local TabButtons = {}
local CurrentTab = "INFO"

for i, tabName in ipairs(Tabs) do
    local TabBtn = Instance.new("TextButton")
    TabBtn.Size = UDim2.new(0, 130, 1, 0)
    TabBtn.Position = UDim2.new(0, (i-1)*135 + 10, 0, 0)
    TabBtn.BackgroundColor3 = i == 1 and Color3.fromRGB(70, 150, 255) or Color3.fromRGB(50, 50, 70)
    TabBtn.Text = tabName
    TabBtn.TextColor3 = Color3.new(1,1,1)
    TabBtn.TextScaled = true
    TabBtn.Font = Enum.Font.GothamBold
    TabBtn.Parent = Header
    
    local TabCorner = Instance.new("UICorner")
    TabCorner.CornerRadius = UDim.new(0, 8)
    TabCorner.Parent = TabBtn
    
    TabBtn.MouseButton1Click:Connect(function()
        CurrentTab = tabName
        for _, btn in pairs(TabButtons) do
            btn.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
        end
        TabBtn.BackgroundColor3 = Color3.fromRGB(70, 150, 255)
        updateTabContent()
    end)
    TabButtons[tabName] = TabBtn
end

-- Close button
local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 40, 0, 40)
CloseBtn.Position = UDim2.new(1, -50, 0, 8)
CloseBtn.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
CloseBtn.Text = "âœ•"
CloseBtn.TextColor3 = Color3.new(1,1,1)
CloseBtn.TextScaled = true
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.Parent = Header
local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseBtn

-- Content area
local ContentFrame = Instance.new("Frame")
ContentFrame.Size = UDim2.new(1, -20, 1, -75)
ContentFrame.Position = UDim2.new(0, 10, 0, 65)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainFrame

-- Tab content containers WITH ScrollFrames properly created
local TabContents = {}
for _, tab in ipairs(Tabs) do
    local Container = Instance.new("Frame")
    Container.Size = UDim2.new(1, 0, 1, 0)
    Container.BackgroundTransparency = 1
    Container.Visible = tab == "INFO"
    Container.Parent = ContentFrame
    TabContents[tab] = Container
    
    -- Create ScrollFrame INSIDE container
    local Scroll = Instance.new("ScrollingFrame")
    Scroll.Size = UDim2.new(1, -20, 1, -20)
    Scroll.Position = UDim2.new(0, 10, 0, 10)
    Scroll.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
    Scroll.BorderSizePixel = 0
    Scroll.ScrollBarThickness = 8
    Scroll.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 150)
    Scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    Scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    Scroll.Parent = Container
    
    local ScrollCorner = Instance.new("UICorner")
    ScrollCorner.CornerRadius = UDim.new(0, 8)
    ScrollCorner.Parent = Scroll
    
    -- Store scroll reference properly
    TabContents[tab].ScrollFrame = Scroll
end

-- INFO Tab - Create actual named labels for updating
local InfoScroll = TabContents.INFO.ScrollFrame
local InfoLayout = Instance.new("UIListLayout")
InfoLayout.Padding = UDim.new(0, 8)
InfoLayout.SortOrder = Enum.SortOrder.LayoutOrder
InfoLayout.Parent = InfoScroll

local VersionLabel = createInfoLabel("ðŸŒ€ Rift Scanner v2.1", Color3.fromRGB(100, 255, 100))
local UptimeLabel = createInfoLabel("Uptime: 00:00", Color3.fromRGB(200, 200, 255))
local ActiveLabel = createInfoLabel("Active Rifts: 0", Color3.fromRGB(255, 200, 100))
local WorldLabel = createInfoLabel("Current World: Loading...", Color3.fromRGB(150, 255, 150))

function createInfoLabel(text, color)
    local Label = Instance.new("TextLabel")
    Label.Name = text:gsub("[: ]", "")  -- Make valid name
    Label.Size = UDim2.new(1, 0, 0, 40)
    Label.BackgroundColor3 = Color3.fromRGB(45, 45, 65)
    Label.Text = text
    Label.TextColor3 = color or Color3.fromRGB(255, 255, 255)
    Label.TextScaled = true
    Label.Font = Enum.Font.Gotham
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.TextYAlignment = Enum.TextYAlignment.Center
    Label.Parent = InfoScroll
    
    local LCorner = Instance.new("UICorner")
    LCorner.CornerRadius = UDim.new(0, 8)
    LCorner.Parent = Label
    
    return Label
end

-- Rift scanning vars
local ActiveRifts = {}
local HumanoidRootPart
local SCRIPT_UPTIME = 0

local Character = LocalPlayer.CharacterAdded:Wait()
HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    HumanoidRootPart = char:WaitForChild("HumanoidRootPart")
end)

-- Rift scan functions
local function parseRiftStats(riftModel)
    local stats = {Luck = "?", Timer = "?"}
    local display = riftModel:FindFirstChild("Display")
    if display and display:FindFirstChild("SurfaceGui") then
        local gui = display.SurfaceGui
        for _, child in pairs(gui:GetDescendants()) do
            if child:IsA("TextLabel") and child.Name == "Luck" then
                stats.Luck = child.Text
            elseif child:IsA("TextLabel") and child.Name:lower():find("timer") then
                stats.Timer = child.Text
            end
        end
    end
    return stats
end

local function getEggPlatformSpawn(riftModel)
    local platform = riftModel:FindFirstChild("EggPlatformSpawn")
    if platform then
        local children = platform:GetChildren()
        if #children >= 4 and children[4]:IsA("BasePart") then
            return children[4]
        elseif platform.PrimaryPart then
            return platform.PrimaryPart
        else
            for _, child in pairs(platform:GetChildren()) do
                if child:IsA("BasePart") then return child end
            end
        end
    end
    return nil
end

local function scanActiveRifts()
    ActiveRifts = {}
    local riftsFolder = workspace.Rendered:FindFirstChild("Rifts")
    if not riftsFolder then return end
    
    for _, riftModel in pairs(riftsFolder:GetChildren()) do
        if riftModel.Name:match("-?rift") or riftModel.Name:match("egg") or riftModel.Name:match("chest") then
            local platform = getEggPlatformSpawn(riftModel)
            local stats = parseRiftStats(riftModel)
            
            table.insert(ActiveRifts, {
                Model = riftModel, Name = riftModel.Name, Platform = platform,
                Position = platform and platform.Position or riftModel:GetPivot().Position,
                Distance = (platform and platform.Position or riftModel:GetPivot().Position - HumanoidRootPart.Position).Magnitude,
                Stats = stats, RiftKey = riftModel.Name
            })
        end
    end
end

local function teleportToRift(riftData)
    if riftData.Platform and HumanoidRootPart then
        HumanoidRootPart.CFrame = CFrame.new(riftData.Position + Vector3.new(0, 5, 0))
        print("âœ¨ Teleported to " .. riftData.Name .. " (x" .. riftData.Stats.Luck .. ")")
    end
end

-- Tab content updater (FIXED)
function updateTabContent()
    local container = TabContents[CurrentTab]
    if not container or not container.ScrollFrame then return end
    
    local scroll = container.ScrollFrame
    
    -- Clear existing content
    for _, child in pairs(scroll:GetChildren()) do
        if child:IsA("GuiObject") and child ~= InfoLayout then
            child:Destroy()
        end
    end
    
    if CurrentTab == "INFO" then
        -- Update existing info labels
        local uptime = math.floor(SCRIPT_UPTIME)
        local minutes = math.floor(uptime / 60)
        local seconds = uptime % 60
        if UptimeLabel then UptimeLabel.Text = "Uptime: " .. string.format("%02d:%02d", minutes, seconds) end
        if ActiveLabel then ActiveLabel.Text = "Active Rifts: " .. #ActiveRifts end
        local world = success2 and WorldUtil:GetPlayerWorld(LocalPlayer) or "Unknown"
        if WorldLabel then WorldLabel.Text = "Current World: " .. world end
        
    elseif CurrentTab == "RIFTS" then
        local layout = Instance.new("UIListLayout")
        layout.Padding = UDim.new(0, 6)
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        layout.Parent = scroll
        
        for riftKey, riftData in pairs(RIFT_DATA) do
            if not riftData.Ignore then
                local btn = Instance.new("TextButton")
                btn.Size = UDim2.new(1, 0, 0, 55)
                btn.BackgroundColor3 = Color3.fromRGB(45, 45, 65)
                btn.Text = ""
                btn.Parent = scroll
                
                local bCorner = Instance.new("UICorner")
                bCorner.CornerRadius = UDim.new(0, 8)
                bCorner.Parent = btn
                
                local nameLabel = Instance.new("TextLabel")
                nameLabel.Size = UDim2.new(1, -130, 0.6, 0)
                nameLabel.Position = UDim2.new(0, 10, 0, 2)
                nameLabel.BackgroundTransparency = 1
                nameLabel.Text = (riftData.DisplayName or riftKey) .. " (" .. riftData.Type .. ")"
                nameLabel.TextColor3 = Color3.new(1,1,1)
                nameLabel.TextScaled = true
                nameLabel.Font = Enum.Font.GothamBold
                nameLabel.TextXAlignment = Enum.TextXAlignment.Left
                nameLabel.Parent = btn
                
                local statusLabel = Instance.new("TextLabel")
                statusLabel.Size = UDim2.new(0, 120, 1, 0)
                statusLabel.Position = UDim2.new(1, -125, 0, 0)
                statusLabel.BackgroundTransparency = 1
                statusLabel.TextScaled = true
                statusLabel.Font = Enum.Font.GothamBold
                statusLabel.TextXAlignment = Enum.TextXAlignment.Right
                statusLabel.Parent = btn
                
                local matching = {}
                for _, r in ipairs(ActiveRifts) do
                    if r.RiftKey == riftKey or r.Name == riftKey then 
                        table.insert(matching, r) 
                    end
                end
                
                if #matching > 0 then
                    local first = matching[1]
                    statusLabel.Text = "x" .. first.Stats.Luck .. "\n(" .. #matching .. ")"
                    statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
                    btn.BackgroundColor3 = Color3.fromRGB(80, 140, 80)
                else
                    statusLabel.Text = "âŒ"
                    statusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
                end
                
                btn.MouseButton1Click:Connect(function()
                    if #matching > 0 then 
                        teleportToRift(matching[1]) 
                    end
                end)
            end
        end
        
    elseif CurrentTab == "EGGS" then
        createTabLabel(scroll, "ðŸ¥š Egg Hatching Stats & Boosters", "Coming soon...")
    elseif CurrentTab == "QUESTS" then
        createTabLabel(scroll, "ðŸ“œ Active Quests & Progress", "Coming soon...")
    end
end

function createTabLabel(scroll, title, subtitle)
    local layout = Instance.new("UIListLayout")
    layout.Padding = UDim.new(0, 10)
    layout.Parent = scroll
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 0, 60)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 200)
    titleLabel.TextScaled = true
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Parent = scroll
    
    local subLabel = Instance.new("TextLabel")
    subLabel.Size = UDim2.new(1, 0, 0, 40)
    subLabel.BackgroundTransparency = 1
    subLabel.Text = subtitle
    subLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    subLabel.TextScaled = true
    subLabel.Font = Enum.Font.Gotham
    subLabel.Parent = scroll
end

-- Toggle menu
MiniBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

CloseBtn.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- Drag functionality
local dragging, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
    end
end)

MainFrame.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, 
                                      startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

MainFrame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

-- Main update loop
local ScanConnection
ScanConnection = RunService.Heartbeat:Connect(function()
    SCRIPT_UPTIME = tick() - SCRIPT_START
    pcall(scanActiveRifts)
    pcall(updateTabContent)
end)

WorldUtil and WorldUtil.OnPlayerWorldChanged and WorldUtil:OnPlayerWorldChanged(LocalPlayer, updateTabContent)

print("ðŸŒ€ Rift Menu v2.1 loaded! Click ðŸŒ€ button top-right to toggle")
updateTabContent()
