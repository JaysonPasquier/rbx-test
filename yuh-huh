-- BGSI Premium Hub v2026 - FIXED VERSION
-- ‚úÖ SHORTER HEIGHT + MINIMIZE BUTTON + FULL CONTENT + DRAGGABLE + BACKGROUND

getgenv().script_key = "uIeCsXNDMliclXkKGlfNwXHZHFblrJZl"

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

print("üßº BGSI Premium Hub v2026 - LOADING...")

-- Load Linoria Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/main/Library.lua"))()
local ThemeManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/main/addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/main/addons/SaveManager.lua"))()

print("‚úÖ LinoriaLib loaded successfully")

-- === CREATE WINDOW ===
local Window = Library:CreateWindow({
    Title = "üßº BGSI Hub",
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2
})

print("‚úÖ Window created - applying mobile optimization...")

-- üì± MOBILE OPTIMIZATION - Resize LinoriaLib window to fit phone screens
task.wait(0.5)  -- Wait for LinoriaLib to fully create UI

local function optimizeForMobile()
    local screenGui = nil
    local mainFrame = nil

    -- Find LinoriaLib's ScreenGui
    for _, gui in pairs(playerGui:GetChildren()) do
        if gui:IsA("ScreenGui") and gui.Name:find("Library") then
            screenGui = gui
            -- Find the main window container
            for _, desc in pairs(gui:GetDescendants()) do
                if desc:IsA("Frame") and (desc.Name == "Window" or desc.Name == "Holder") then
                    mainFrame = desc
                    break
                end
            end
            if mainFrame then break end
        end
    end

    if not mainFrame then
        warn("‚ö†Ô∏è Could not find LinoriaLib frame for mobile optimization")
        return
    end

    print("‚úÖ Found UI frame: " .. mainFrame.Name)

    -- üì± MOBILE-FRIENDLY SIZING
    local screenSize = workspace.CurrentCamera.ViewportSize
    local isMobile = screenSize.X < 600 or screenSize.Y < 400

    if isMobile then
        print("üì± Mobile device detected - optimizing UI...")

        -- Resize to fit mobile screen (MUCH smaller for phones)
        local targetWidth = math.min(screenSize.X * 0.85, 340)
        local targetHeight = math.min(screenSize.Y * 0.65, 320)  -- SHORTER! Max 320px height

        mainFrame.Size = UDim2.new(0, targetWidth, 0, targetHeight)
        mainFrame.Position = UDim2.new(0.5, -targetWidth/2, 0.5, -targetHeight/2)

        -- Add UIScale to make text/buttons smaller
        local uiScale = mainFrame:FindFirstChildOfClass("UIScale")
        if not uiScale then
            uiScale = Instance.new("UIScale")
            uiScale.Scale = 0.9  -- 90% size for mobile (readable but compact)
            uiScale.Parent = mainFrame
        else
            uiScale.Scale = 0.9
        end

        print("‚úÖ Mobile optimization applied:")
        print("   üìè Window: " .. math.floor(targetWidth) .. "x" .. math.floor(targetHeight))
        print("   üì± Screen: " .. math.floor(screenSize.X) .. "x" .. math.floor(screenSize.Y))
        print("   üîç Scale: " .. uiScale.Scale)
    else
        print("üíª Desktop detected - using standard size")
        -- Standard desktop size
        mainFrame.Size = UDim2.new(0, 550, 0, 500)
        mainFrame.Position = UDim2.new(0.5, -275, 0.5, -250)
    end

    -- Make sure it's on screen and visible
    screenGui.ResetOnSpawn = false
    screenGui.IgnoreGuiInset = true
    mainFrame.Visible = true

    print("‚úÖ UI optimization complete!")
end

-- Apply optimization
local success, err = pcall(optimizeForMobile)
if not success then
    warn("‚ö†Ô∏è Mobile optimization failed: " .. tostring(err))
end

print("‚úÖ Window ready")

-- === STATE MANAGEMENT ===
local state = {
    autoBlow = false, autoHatch = false, riftPriority = nil, eggPriority = nil,
    webhookUrl = "", webhookStats = true, currentRifts = {}, currentEggs = {},
    stats = {bubbles=0, hatches=0, coins=0, bubbleStock=0, gems=0},
    startTime = tick(), labels = {}, dropdowns = {}
}

-- === DATA ===
local petData, _codeData
pcall(function()
    petData = require(RS.Shared.Data.Pets)
    _codeData = require(RS.Shared.Data.Codes)
end)

-- === UTILITY FUNCTIONS ===
local function SendWebhook(url, msg)
    pcall(function()
        request({
            Url = url, Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({content = msg})
        })
    end)
end

local function updateStats()
    local leaderstats = player:FindFirstChild("leaderstats")
    if leaderstats then
        state.stats.bubbles = leaderstats:FindFirstChild("Bubbles") and leaderstats.Bubbles.Value or 0
        state.stats.hatches = leaderstats:FindFirstChild("Hatches") and leaderstats.Hatches.Value or 0
    end

    pcall(function()
        local screenGui = playerGui:FindFirstChild("ScreenGui")
        if screenGui and screenGui:FindFirstChild("HUD") then
            local currencyFrame = screenGui.HUD:FindFirstChild("Left", true):FindFirstChild("Currency", true)
            if currencyFrame then
                for _, currency in pairs(currencyFrame:GetChildren()) do
                    local label = currency:FindFirstChild("Frame", true):FindFirstChild("Label")
                    if label then
                        local value = tonumber(label.Text:match("%d+")) or 0
                        local name = currency.Name:lower()
                        if name == "coins" then state.stats.coins = value end
                        if name == "bubble" then state.stats.bubbleStock = value end
                        if name == "gems" then state.stats.gems = value end
                    end
                end
            end
        end
    end)
end

local function scanRifts()
    state.currentRifts = {}
    pcall(function()
        local rendered = Workspace:FindFirstChild("Rendered")
        if rendered and rendered:FindFirstChild("Rifts") then
            for _, rift in pairs(rendered.Rifts:GetChildren()) do
                local display = rift:FindFirstChild("Display")
                if display then
                    local timer = display:FindFirstChild("Timer")
                    local icon = display:FindFirstChild("Icon")
                    local luck = icon and icon:FindFirstChild("Luck")
                    table.insert(state.currentRifts, {
                        name = rift.Name,
                        timer = timer and timer.Text or "00:00",
                        luck = luck and luck.Text or "x1",
                        instance = rift
                    })
                end
            end
        end
    end)
end

local function scanEggs()
    state.currentEggs = {}
    pcall(function()
        local rendered = Workspace:FindFirstChild("Rendered")
        if rendered then
            for _, folder in pairs(rendered:GetChildren()) do
                if folder.Name:lower():find("chuncker") then
                    for _, egg in pairs(folder:GetChildren()) do
                        if egg.Name ~= "Coming Soon" then
                            table.insert(state.currentEggs, {name = egg.Name, instance = egg})
                        end
                    end
                end
            end
        end
    end)
end

local function tpToModel(model)
    pcall(function()
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = player.Character.HumanoidRootPart
            local cf = model:FindFirstChild("EggPlatformSpawn")
                and model.EggPlatformSpawn:GetModelCFrame()
                or model:GetModelCFrame()
            hrp.CFrame = cf + Vector3.new(0, 5, 0)
        end
    end)
end

-- === CREATE TABS ===
local MainTab = Window:AddTab("üè† Main")
local FarmTab = Window:AddTab("üîß Farm")
local EggsTab = Window:AddTab("ü•ö Eggs")
local RiftsTab = Window:AddTab("üåå Rifts")
local WebTab = Window:AddTab("üìä Webhook")
local DataTab = Window:AddTab("üìã Data")

-- === MAIN TAB ===
local MainGroupBox = MainTab:AddLeftGroupbox("üìä Live Stats")
state.labels = {
    runtime = MainGroupBox:AddLabel("Runtime: 00:00:00"),
    bubbles = MainGroupBox:AddLabel("Bubbles: 0"),
    hatches = MainGroupBox:AddLabel("Hatches: 0"),
    coins = MainGroupBox:AddLabel("Coins: 0"),
    bubbleStock = MainGroupBox:AddLabel("Bubble Stock: 0"),
    gems = MainGroupBox:AddLabel("Gems: 0")
}

-- üì± MOBILE CONTROLS
local MobileGroupBox = MainTab:AddRightGroupbox("üì± Mobile Settings")

MobileGroupBox:AddButton({
    Text = "üîç Tiny Mode (Phone)",
    Tooltip = "Ultra compact: 320x280",
    Func = function()
        pcall(function()
            for _, gui in pairs(playerGui:GetChildren()) do
                if gui:IsA("ScreenGui") and gui.Name:find("Library") then
                    -- Find the actual main frame (not nested)
                    for _, child in pairs(gui:GetDescendants()) do
                        if child:IsA("Frame") and (child.Name == "Window" or child.Name == "Holder") then
                            child.Size = UDim2.new(0, 320, 0, 280)
                            child.Position = UDim2.new(0.5, -160, 0.5, -140)
                            Library:Notify("üì± Tiny mode (320x280)", 2)
                            break
                        end
                    end
                end
            end
        end)
    end
})

MobileGroupBox:AddButton({
    Text = "üìè Compact (Small)",
    Tooltip = "Small size: 360x350",
    Func = function()
        pcall(function()
            for _, gui in pairs(playerGui:GetChildren()) do
                if gui:IsA("ScreenGui") and gui.Name:find("Library") then
                    for _, child in pairs(gui:GetDescendants()) do
                        if child:IsA("Frame") and (child.Name == "Window" or child.Name == "Holder") then
                            child.Size = UDim2.new(0, 360, 0, 350)
                            child.Position = UDim2.new(0.5, -180, 0.5, -175)
                            Library:Notify("üìè Compact mode (360x350)", 2)
                            break
                        end
                    end
                end
            end
        end)
    end
})

MobileGroupBox:AddButton({
    Text = "ÔøΩ Medium (Tablet)",
    Tooltip = "Medium size: 420x420",
    Func = function()
        pcall(function()
            for _, gui in pairs(playerGui:GetChildren()) do
                if gui:IsA("ScreenGui") and gui.Name:find("Library") then
                    for _, child in pairs(gui:GetDescendants()) do
                        if child:IsA("Frame") and (child.Name == "Window" or child.Name == "Holder") then
                            child.Size = UDim2.new(0, 420, 0, 420)
                            child.Position = UDim2.new(0.5, -210, 0.5, -210)
                            Library:Notify("üì± Medium mode (420x420)", 2)
                            break
                        end
                    end
                end
            end
        end)
    end
})

MobileGroupBox:AddButton({
    Text = "üìç Center Window",
    Tooltip = "Recenter on screen",
    Func = function()
        pcall(function()
            for _, gui in pairs(playerGui:GetChildren()) do
                if gui:IsA("ScreenGui") and gui.Name:find("Library") then
                    for _, child in pairs(gui:GetDescendants()) do
                        if child:IsA("Frame") and (child.Name == "Window" or child.Name == "Holder") then
                            local w = child.Size.X.Offset
                            local h = child.Size.Y.Offset
                            child.Position = UDim2.new(0.5, -w/2, 0.5, -h/2)
                            Library:Notify("üìç Window centered", 2)
                            break
                        end
                    end
                end
            end
        end)
    end
})

-- === FARM TAB ===
local FarmGroupBox = FarmTab:AddLeftGroupbox("ü§ñ Auto Farm")
FarmGroupBox:AddToggle("AutoBlow", {
    Text = "üßº Auto Blow Bubbles",
    Default = false,
    Callback = function(v)
        state.autoBlow = v
        Library:Notify("Auto Blow " .. (v and "ON" or "OFF"), 2)
    end
})

-- === EGGS TAB ===
local EggGroupBox = EggsTab:AddLeftGroupbox("ü•ö Eggs")
state.dropdowns.egg = EggGroupBox:AddDropdown("EggSelect", {
    Values = {},
    AllowNull = true,
    Text = "Scan eggs first",
    Callback = function(option)
        if option then
            state.eggPriority = option
            for _, egg in pairs(state.currentEggs) do
                if egg.name == option then
                    tpToModel(egg.instance)
                    Library:Notify("TP to " .. option, 2)
                    break
                end
            end
        end
    end
})

EggGroupBox:AddToggle("AutoHatch", {
    Text = "üîÑ Auto Hatch",
    Default = false,
    Callback = function(v) state.autoHatch = v end
})

EggGroupBox:AddButton({
    Text = "üîÑ Scan Eggs",
    Func = function()
        scanEggs()
        local names = {}
        for _, egg in pairs(state.currentEggs) do
            table.insert(names, egg.name)
        end
        state.dropdowns.egg:Refresh(names)
        Library:Notify(#names .. " eggs found!", 2)
    end
})

-- === RIFTS TAB ===
local RiftGroupBox = RiftsTab:AddLeftGroupbox("üåå Rifts")
state.dropdowns.rift = RiftGroupBox:AddDropdown("RiftSelect", {
    Values = {},
    AllowNull = true,
    Text = "Scan rifts first",
    Callback = function(option)
        if option then
            local name = option:match("^(.+?) |") or option
            state.riftPriority = name
            for _, rift in pairs(state.currentRifts) do
                if rift.name == name then
                    tpToModel(rift.instance)
                    Library:Notify("TP to " .. name, 2)
                    break
                end
            end
        end
    end
})

RiftGroupBox:AddButton({
    Text = "üîÑ Scan Rifts",
    Func = function()
        scanRifts()
        local names = {}
        for _, rift in pairs(state.currentRifts) do
            table.insert(names, rift.name .. " | " .. rift.timer .. " | " .. rift.luck)
        end
        state.dropdowns.rift:Refresh(names)
        Library:Notify(#names .. " rifts found!", 2)
    end
})

-- === WEBHOOK TAB ===
local WebGroupBox = WebTab:AddLeftGroupbox("üí¨ Discord")
state.webhookInput = WebGroupBox:AddInput("WebhookURL", {
    Text = "Webhook URL",
    Default = "",
    Placeholder = "https://discord.com/api/webhooks/...",
    Callback = function(text) state.webhookUrl = text end
})

WebGroupBox:AddToggle("StatsWebhook", {
    Text = "üìä Send Stats",
    Default = true,
    Callback = function(v) state.webhookStats = v end
})

WebGroupBox:AddButton({
    Text = "üß™ Test",
    Func = function()
        if state.webhookUrl == "" then
            Library:Notify("Add webhook URL!", 3)
            return
        end
        SendWebhook(state.webhookUrl, "**üßº BGSI Test** " .. os.date("%H:%M"))
        Library:Notify("Test sent!", 2)
    end
})

-- === DATA TAB ===
if petData then
    local PetGroupBox = DataTab:AddLeftGroupbox("üêæ Pets")
    local count = 0
    for name, data in pairs(petData) do
        if data.Rarity and count < 15 then
            PetGroupBox:AddLabel(name .. " [" .. data.Rarity .. "]")
            count += 1
        end
    end
else
    local PetGroupBox = DataTab:AddLeftGroupbox("üêæ Pets")
    PetGroupBox:AddLabel("Pet data not available in this game")
end

print("‚úÖ All tabs created successfully!")

-- ‚úÖ Setup Theme & Save Managers
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
SaveManager:SetFolder("BGSIHub")
ThemeManager:ApplyToTab(DataTab)  -- Add theme options to last tab
SaveManager:BuildConfigSection(DataTab)  -- Add save/load to last tab
print("‚úÖ Theme and Save managers ready")

-- === MAIN LOOPS ===
task.spawn(function()
    while task.wait(0.1) do
        updateStats()
        scanRifts()
        scanEggs()
        if state.autoBlow then
            -- RS.Remotes.BlowBubbleRemote:FireServer()
        end
        if state.autoHatch and state.eggPriority then
            for _, egg in pairs(state.currentEggs) do
                if egg.name == state.eggPriority then
                    tpToModel(egg.instance)
                    break
                end
            end
        end
    end
end)

task.spawn(function()
    while task.wait(1) do
        local runtime = tick() - state.startTime
        local h,m,s = math.floor(runtime/3600), math.floor((runtime%3600)/60), math.floor(runtime%60)

        pcall(function()
            state.labels.runtime:Set("Runtime: " .. string.format("%02d:%02d:%02d", h,m,s))
            state.labels.bubbles:Set("Bubbles: " .. state.stats.bubbles)
            state.labels.hatches:Set("Hatches: " .. state.stats.hatches)
            state.labels.coins:Set("Coins: " .. state.stats.coins)
            state.labels.bubbleStock:Set("Bubble Stock: " .. state.stats.bubbleStock)
            state.labels.gems:Set("Gems: " .. state.stats.gems)
        end)
    end
end)

-- Initial scans
scanEggs()
scanRifts()

print("‚úÖ ==========================================")
print("‚úÖ BGSI Premium Hub - READY!")
print("‚úÖ ==========================================")
print("üìã Tabs:")
print("   üè† Main - Stats + Mobile resize buttons")
print("   üîß Farm - Auto blow bubbles")
print("   ü•ö Eggs - Scanner & auto hatch")
print("   üåå Rifts - Scanner & teleport")
print("   üìä Webhook - Discord webhooks")
print("   üìã Data - Pet info & theme")
print("‚úÖ ==========================================")
print("üì± MOBILE USERS:")
print("   ‚Ä¢ Go to Main tab > Mobile Settings")
print("   ‚Ä¢ Click 'Compact Mode' button")
print("   ‚Ä¢ UI will resize to fit your screen!")
print("‚úÖ ==========================================")
print("üí° Right-click title bar = minimize")
print("üí° Drag title bar = move window")
print("‚úÖ ==========================================")

Library:Notify("üßº BGSI Hub Ready!\nüì± Check Main tab for mobile controls", 5)
